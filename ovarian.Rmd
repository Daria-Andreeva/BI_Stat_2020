---
title: "Мини-проект анализ выживаемости"
output: html_document
---

Нам понадобятся следующие пакеты. 

* [readxl](https://cran.r-project.org/web/packages/readxl/index.html)

* [plyr](https://github.com/sampotts/plyr)

* [dplyr](https://cran.r-project.org/web/packages/dplyr/index.html)

* [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html)

* [corrplot](https://cran.r-project.org/web/packages/corrplot/index.html)

* [survival](https://cran.r-project.org/web/packages/survival/index.html)

* [survminer](https://cran.r-project.org/web/packages/survminer/index.html)

* [coin](https://cran.r-project.org/web/packages/coin/index.html)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(ggplot2)
library(plyr)
library(dplyr)
library(corrplot)
library(survminer)
library(coin)
```

Датасет ovarian содержит данные о рандомизированном исследовании, которое сравнивает два метода лечение рака яичников.


# 1. EDA

Посмотрим на первые 6 строк датасета. 
```{r}
head(ovarian)
```

```{r}
str(ovarian)
# сохраним датасет с числовыми значениями для рассчета корреляционной матрицы
d <- ovarian
```

Поскольку параметры futime, resid.ds, rx и ecog.ps являются факторными, изменим их тип.

```{r}
ovarian$resid.ds <- factor(ovarian$resid.ds, 
                           levels = c("1", "2"), 
                           labels = c("no", "yes"))
ovarian$ecog.ps <- factor(ovarian$ecog.ps, 
                          levels = c("1", "2"), 
                          labels = c("good", "bad"))
ovarian$rx <- factor(ovarian$rx, 
                     levels = c("1", "2"), 
                     labels = c("A", "B"))
str(ovarian)
```

```{r}
summary(ovarian)
```

Всего 26 пациенток, группы сбалансированы по типу лекарства. У 15 пациенток присутствует болезнь на дату создания датасета, у 12 пациенток цензурированные данные. Средний возраст пациенток 56 лет, самой младшей - 38, старшей - 74. 14 пациенток имееют лучший ECOG статус. 

#### Построим гистограммы распределения.
```{r}

mu <- ddply(ovarian, "rx", summarise, futime=mean(futime), age = mean(age))
time <- ggplot(ovarian, aes(x = futime, color = rx)) +
  geom_histogram(position="identity", fill = 'white', alpha = 0.5) +
  geom_vline(data=mu, aes(xintercept=futime, color=rx),
             linetype="dashed")

age <- ggplot(ovarian, aes(x = age, color = rx)) +
  geom_histogram(position="identity", fill = 'white', alpha = 0.5) +
  geom_vline(data=mu, aes(xintercept=age, color=rx),
             linetype="dashed")

```

#### Посчитаем коэффициенты корреляции.
```{r}

c <- cor(d)
# mat : is a matrix of data
# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(c)
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(c, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.05, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
```

Значимо (p > 0.05) корреллируют друг с другом параметры futime и fustat, futime и age - с отрицательной связью, и futime и fustat - с положительной. Таким образом, можно сделать предварительный вывод о том, что с увеличением возраста уменьшается количество времени наблюдения, но так же увеличивается и количество цензурированных данных, что может говорить не только о том, что с возрастом смертность увеличивается, но и о том, что с возрастом больше пациенток не проходят скриннинги. 

# 2. Кривые Каплана-Мейра
```{r}

ovarian <- ovarian %>% mutate(age_group = ifelse(age >=50, "old", "young"))
ovarian$age_group <- factor(ovarian$age_group)
ovarian <- ovarian %>% mutate(age_group = ifelse(age >=50, "old", "young"))
ovarian$age_group <- factor(ovarian$age_group)
d$age_group <- ovarian$age_group
```
Узнаем, какие данные закончились смертью.
```{r}
# censored data has '+'
surv_object <- Surv(time = ovarian$futime, event = ovarian$fustat)
surv_object 

# good status has '+'
# мне стало интересно есть ли какое-то влияние на то, какой статус будет у пациента

surv_object_1 <- Surv(time = d$futime, event = d$ecog.ps)
surv_object_1
```

#### Построим кривые Каплана-Майера
```{r}
mod1 <- survfit(surv_object ~ rx, data = ovarian)
summary(mod1)
ggsurvplot(mod1, data = ovarian, pval = TRUE)

mod_1 <- survfit(surv_object_1 ~ rx, data = d)
summary(mod_1)
ggsurvplot(mod_1, data = d, pval = TRUE)
```
Значение р = 0,3 и 0,45 говорит, о том, что оба лекарства действуют одинаково на всех пациентов. Однако, пациенты принимающие лечение В в первый месяц чувствуют себя лучше.

```{r}
mod2 <- survfit(surv_object ~ resid.ds, data = ovarian)
summary(mod2)
ggsurvplot(mod2, data = ovarian, pval = TRUE)
mod_2 <- survfit(surv_object_1 ~ resid.ds, data = d)
summary(mod_2)
ggsurvplot(mod_2, data = d, pval = TRUE)
```

Значение р является практически значимым, из чего можно сделать вывод, что пациенты с остаточным заболеванием имееют худшие шансы на выживание.
Значение р = 0,44 говорит о том, что параметр не имеет никакого влияния на статус пациента.

```{r}
mod3 <- survfit(surv_object ~ age_group, data = ovarian)
summary(mod3)
ggsurvplot(mod3, data = ovarian, pval = TRUE)

mod_3 <- survfit(surv_object_1 ~ age_group, data = d)
summary(mod_3)
ggsurvplot(mod_3, data = d, pval = TRUE)
```

Значение р = 0,1 говорит о том, что влияние возраста пациента на момент постановки диагноза также не влияет на исход заболевания.
Значение р = 0,12 говорит о том, что параметр не имеет никакого влияния на статус пациента.

# 3. Лог-ранк тест
```{r}
logrank_test(Surv(ovarian$futime, ovarian$fustat) ~ rx, data = ovarian)
```
```{r}
logrank_test(Surv(ovarian$futime, ovarian$fustat) ~ resid.ds, data = ovarian)
```
```{r}
logrank_test(Surv(ovarian$futime, ovarian$fustat) ~ age_group, data = ovarian)
```

Значения значимости при расчете лог-ранк теста практически не отличаются от тех (rx: 0,3 и 0,3032; resid.ds: 0,057 и 0,0544; age_group: 0,097 и 0,07231), что были рассчитаны при построении кривых К.-М., что позволяет повторить предыдущие выводы. 

# 4. Анализ факторов, влияющих на риск (модель Кокса).

```{r}
cox <- coxph(formula = Surv(futime, fustat) ~ age_group + rx + resid.ds, data = ovarian)
summary(cox)
cox_fit <- survfit(cox)
plot(cox_fit)
```
Данный анализ выделил только одну значимую группу - лекарство В. 

#### Построим визуализацию влияния параметров.
```{r, message=FALSE}
aa_fit <- aareg(formula = Surv(futime, fustat) ~ age_group + rx + resid.ds, data = ovarian)
plot(aa_fit)
```

# 5. Построим отношение рисков (Hazard Ratio)

```{r}
fit.coxph <- coxph(surv_object ~ rx + resid.ds + age_group + ecog.ps, 
                   data = ovarian)
ggforest(fit.coxph, data = ovarian)
```
Отношение рисков показывает значимую связь лекарства В с риском смерти, что позволяет сделать вывод, что лекарство В на 20% (в среднем) более эффективное. Также мы видим, что статус остаточного заболевания и возраст пациента также значительно влияют на риск смерти пациентов в этом исследовании. Наличие остаточного заболевания на 64% (в среднем) увеличивает риска смерти, а возраст менее 50 лет - на 10% (в среднем) понижает риск.

```{r}
fit.coxph_1 <- coxph(surv_object_1 ~ rx + resid.ds + age_group, 
                   data = ovarian)
ggforest(fit.coxph_1, data = ovarian)
```
Применение лекарства В на 17% в среднем повышает риск лучшего статуса ECOG, а возраст менее 50 лет - на 9% (в среднем).

